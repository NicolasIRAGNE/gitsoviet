# gitsoviet

GitHub App that listens to pull request events on opted-in repositories and responds with a Soviet-style propaganda poster generated by an image provider (ChatGPT by default).

## Features

- Handles `opened`, `reopened`, and `synchronize` pull request events.
- Builds a detailed prompt using the PR title, description, and changed files.
- Generates a poster image through a pluggable provider (ChatGPT Image API or a dummy placeholder).
- Posts a comment on the pull request with the generated poster and the prompt used.
- On tag pushes, generates a poster image and attaches it to the release for that tag.

## Configuration

Environment variables drive the app behavior:

- `APP_ID`, `PRIVATE_KEY`, `WEBHOOK_SECRET`: Standard GitHub App credentials for Probot.
- `ALLOWED_REPOS`: Optional comma-separated list of `owner/repo` values. When unset, all repos the app is installed on are processed.
- `IMAGE_PROVIDER`: `chatgpt` (default) or `dummy`.
- `OPENAI_API_KEY`: Required for the `chatgpt` image provider.
- `OPENAI_IMAGE_MODEL`: Model name for ChatGPT image generation (defaults to `gpt-image-1`).
- `OPENAI_BASE_URL`: Optional override for the OpenAI endpoint.
- `POSTER_PROMPT`: Custom base prompt to steer the poster style.
- `MAX_FILES`: Number of PR files to include in the prompt (default `10`).
- `IMAGE_WIDTH` / `IMAGE_HEIGHT`: Poster dimensions in pixels (defaults `1024x1536` for portrait). `IMAGE_SIZE` can be used as a
  fallback for both.

Create a `.env` file locally to store these values when running the app.

## Running locally

```bash
npm install
npm run dev
```

Probot will start a development server and listen for GitHub webhook events. Use [smee.io](https://smee.io/) or a similar tunneling service to forward pull request events to your local instance.

## How it works

1. Webhook events for PRs enter the Probot app at `src/index.ts`.
2. The app checks `ALLOWED_REPOS` and skips processing for repositories outside the allow list.
3. The PR metadata and changed files are turned into a detailed prompt (`src/prompt.ts`).
4. The configured image provider (`src/imageProviders.ts`) generates a poster URL.
5. The app comments on the PR with the generated poster and the prompt for transparency.

## Switching providers

- **ChatGPT (default):** Requires `IMAGE_PROVIDER=chatgpt` and `OPENAI_API_KEY` set. Optional `OPENAI_BASE_URL` can point to a compatible API host.
- **Dummy:** Set `IMAGE_PROVIDER=dummy` to respond with a placeholder image for development and testing.

## Release poster workflow

A GitHub Actions workflow (`.github/workflows/release-poster.yml`) runs on tag pushes. It uses the configured image provider to build a release-themed prompt from the tagged commit, renders a poster to `assets/release-poster.png`, and publishes the image as an asset on the corresponding release. Provide the necessary secrets (for example `OPENAI_API_KEY`) so the workflow can contact your chosen image service. The default `GITHUB_TOKEN` is sufficient for creating or updating releases.

## Notes

- The app uses `MAX_FILES` to limit how many changed files are summarized in the image prompt.
- Errors while generating images are reported back to the PR as comments to surface issues quickly.
