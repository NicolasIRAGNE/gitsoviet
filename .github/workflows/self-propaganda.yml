name: Propaganda on main merges and revolutionary labels

on:
  push:
    branches:
      - main
  pull_request_target:
    types:
      - labeled
  issues:
    types:
      - labeled

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-propaganda:
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request_target' && github.event.action == 'labeled' && github.event.label.name == 'revolutionary') ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'revolutionary' && github.event.issue.pull_request)
    runs-on: ubuntu-latest
    steps:
      - name: Resolve pull request and context
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          event="${{ github.event_name }}"

          if [ "$event" = "push" ]; then
            commit_sha="${{ github.sha }}"
            pr_number=$(gh api repos/${{ github.repository }}/commits/${commit_sha}/pulls --jq '.[0].number')

            if [ -z "$pr_number" ] || [ "$pr_number" = "null" ]; then
              echo "No merged pull request found for commit $commit_sha. Skipping poster generation." >&2
              exit 0
            fi

            extra="Celebrate the victorious merge into main at commit ${commit_sha:0:7}."
          elif [ "$event" = "pull_request_target" ]; then
            pr_number="${{ github.event.pull_request.number }}"
            extra="Honor the newly applied revolutionary label on this pull request."
          else
            pr_number="${{ github.event.issue.number }}"
            extra="Honor the newly applied revolutionary label on this pull request."
          fi

          echo "pull_number=$pr_number" >> "$GITHUB_OUTPUT"
          echo "prompt=$extra" >> "$GITHUB_OUTPUT"

      - name: Generate and post poster
        if: steps.pr.outputs.pull_number != ''
        uses: ./.github/workflows/propaganda-review.yml
        with:
          pull_number: ${{ steps.pr.outputs.pull_number }}
          image_prompt: ${{ steps.pr.outputs.prompt }}
        secrets:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
