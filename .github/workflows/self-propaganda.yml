name: Propaganda on main merges and revolutionary tags

on:
  push:
    branches:
      - main
    tags:
      - revolutionary

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-propaganda:
    runs-on: ubuntu-latest
    steps:
      - name: Find pull request for this commit
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          commit_sha="${{ github.sha }}"
          pr_number=$(gh api repos/${{ github.repository }}/commits/${commit_sha}/pulls --jq '.[0].number')

          if [ -z "$pr_number" ] || [ "$pr_number" = "null" ]; then
            echo "No merged pull request found for commit $commit_sha. Skipping poster generation." >&2
            exit 0
          fi

          echo "pull_number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Build extra prompt
        id: prompt
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            extra="Celebrate the revolutionary tag ${GITHUB_REF_NAME} with bold, triumphant imagery."
          else
            extra="Celebrate the victorious merge into main at commit ${GITHUB_SHA:0:7}."
          fi
          echo "prompt=$extra" >> "$GITHUB_OUTPUT"

      - name: Generate and post poster
        if: steps.pr.outputs.pull_number != ''
        uses: ./.github/workflows/propaganda-review.yml
        with:
          pull_number: ${{ steps.pr.outputs.pull_number }}
          image_prompt: ${{ steps.prompt.outputs.prompt }}
        secrets:
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
